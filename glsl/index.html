
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://libplacebo.org/glsl/">
      
      
        <link rel="prev" href="../options/">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>GLSL shader system - libplacebo</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../style.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="deep-purple" data-md-color-accent="deep-purple">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#glsl-shader-system" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="libplacebo" class="md-header__button md-logo" aria-label="libplacebo" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            libplacebo
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              GLSL shader system
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="deep-purple" data-md-color-accent="deep-purple"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="purple" data-md-color-accent="purple"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://code.videolan.org/videolan/libplacebo" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="m504 204.6-.7-1.8L433.6 21c-1.4-3.6-3.9-6.6-7.2-8.6-2.4-1.6-5.1-2.5-8-2.8s-5.7.1-8.4 1.1-5.1 2.7-7.1 4.8c-1.9 2.1-3.3 4.7-4.1 7.4l-47 144H161.3l-47.1-144c-.8-2.8-2.2-5.3-4.1-7.4-2-2.1-4.4-3.7-7.1-4.8-2.6-1-5.5-1.4-8.4-1.1s-5.6 1.2-8 2.8c-3.2 2-5.8 5.1-7.2 8.6L9.8 202.8l-.8 1.8c-10 26.2-11.3 55-3.5 82 7.7 26.9 24 50.7 46.4 67.6l.3.2.6.4 106 79.5c38.5 29.1 66.7 50.3 84.6 63.9 3.7 1.9 8.3 4.3 13 4.3s9.3-2.4 13-4.3c17.9-13.5 46.1-34.9 84.6-63.9l106.7-79.9.3-.3c22.4-16.9 38.7-40.6 45.6-67.5 8.6-27 7.4-55.8-2.6-82"/></svg>
  </div>
  <div class="md-source__repository">
    videolan/libplacebo
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="libplacebo" class="md-nav__button md-logo" aria-label="libplacebo" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    libplacebo
  </label>
  
    <div class="md-nav__source">
      <a href="https://code.videolan.org/videolan/libplacebo" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="m504 204.6-.7-1.8L433.6 21c-1.4-3.6-3.9-6.6-7.2-8.6-2.4-1.6-5.1-2.5-8-2.8s-5.7.1-8.4 1.1-5.1 2.7-7.1 4.8c-1.9 2.1-3.3 4.7-4.1 7.4l-47 144H161.3l-47.1-144c-.8-2.8-2.2-5.3-4.1-7.4-2-2.1-4.4-3.7-7.1-4.8-2.6-1-5.5-1.4-8.4-1.1s-5.6 1.2-8 2.8c-3.2 2-5.8 5.1-7.2 8.6L9.8 202.8l-.8 1.8c-10 26.2-11.3 55-3.5 82 7.7 26.9 24 50.7 46.4 67.6l.3.2.6.4 106 79.5c38.5 29.1 66.7 50.3 84.6 63.9 3.7 1.9 8.3 4.3 13 4.3s9.3-2.4 13-4.3c17.9-13.5 46.1-34.9 84.6-63.9l106.7-79.9.3-.3c22.4-16.9 38.7-40.6 45.6-67.5 8.6-27 7.4-55.8-2.6-82"/></svg>
  </div>
  <div class="md-source__repository">
    videolan/libplacebo
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Using
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            Using
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Introduction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../basic-rendering/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Basic windowing / output example
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../renderer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Rendering content: pl_frame, pl_renderer, and pl_queue
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../custom-shaders/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Custom Shaders (mpv .hook syntax)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../options/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Options
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Developing
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Developing
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    GLSL shader system
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    GLSL shader system
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overall-design" class="md-nav__link">
    <span class="md-ellipsis">
      Overall design
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#legacy-api" class="md-nav__link">
    <span class="md-ellipsis">
      Legacy API
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Legacy API">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#literal-shader-constants" class="md-nav__link">
    <span class="md-ellipsis">
      Literal shader constants
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#specializable-shader-constants" class="md-nav__link">
    <span class="md-ellipsis">
      Specializable shader constants
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamic-variables" class="md-nav__link">
    <span class="md-ellipsis">
      Dynamic variables
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#shader-sections-glsl-glslh-glslf" class="md-nav__link">
    <span class="md-ellipsis">
      Shader sections (GLSL, GLSLH, GLSLF)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#new-pragma-glsl-macro" class="md-nav__link">
    <span class="md-ellipsis">
      New #pragma GLSL macro
    </span>
  </a>
  
    <nav class="md-nav" aria-label="New #pragma GLSL macro">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#shader-variables" class="md-nav__link">
    <span class="md-ellipsis">
      Shader variables
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#macro-directives" class="md-nav__link">
    <span class="md-ellipsis">
      Macro directives
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overall-design" class="md-nav__link">
    <span class="md-ellipsis">
      Overall design
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#legacy-api" class="md-nav__link">
    <span class="md-ellipsis">
      Legacy API
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Legacy API">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#literal-shader-constants" class="md-nav__link">
    <span class="md-ellipsis">
      Literal shader constants
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#specializable-shader-constants" class="md-nav__link">
    <span class="md-ellipsis">
      Specializable shader constants
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamic-variables" class="md-nav__link">
    <span class="md-ellipsis">
      Dynamic variables
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#shader-sections-glsl-glslh-glslf" class="md-nav__link">
    <span class="md-ellipsis">
      Shader sections (GLSL, GLSLH, GLSLF)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#new-pragma-glsl-macro" class="md-nav__link">
    <span class="md-ellipsis">
      New #pragma GLSL macro
    </span>
  </a>
  
    <nav class="md-nav" aria-label="New #pragma GLSL macro">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#shader-variables" class="md-nav__link">
    <span class="md-ellipsis">
      Shader variables
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#macro-directives" class="md-nav__link">
    <span class="md-ellipsis">
      Macro directives
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="glsl-shader-system">GLSL shader system</h1>
<h2 id="overall-design">Overall design</h2>
<p>Shaders in libplacebo are all written in GLSL, and built up incrementally, on
demand. Generally, all shaders for each frame are generated <em>per frame</em>. So
functions like <code>pl_shader_color_map</code> etc. are run anew for every frame. This
makes the renderer very stateless and allows us to directly embed relevant
constants, uniforms etc. as part of the same code that generates the actual
GLSL shader.</p>
<p>To avoid this from becoming wasteful, libplacebo uses an internal string
building abstraction
(<a href="https://code.videolan.org/videolan/libplacebo/-/blob/master/src/pl_string.h#L263"><code>pl_str_builder</code></a>).
Rather than building up a string directly, a <code>pl_str_builder</code> is like a list of
string building functions/callbacks to execute in order to generate the actual
shader. Combined with an efficient <code>pl_str_builder_hash</code>, this allows us to
avoid the bulk of the string templating work for already-cached shaders.</p>
<h2 id="legacy-api">Legacy API</h2>
<p>For the vast majority of libplacebo's history, the main entry-point into the
shader building mechanism was the <code>GLSL()</code> macro (<a href="#shader-sections-glsl-glslh-glslf">and
variants</a>), which works like a
<code>printf</code>-append:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-0-10">10</a></span>
<span class="normal"><a href="#__codelineno-0-11">11</a></span>
<span class="normal"><a href="#__codelineno-0-12">12</a></span>
<span class="normal"><a href="#__codelineno-0-13">13</a></span>
<span class="normal"><a href="#__codelineno-0-14">14</a></span>
<span class="normal"><a href="#__codelineno-0-15">15</a></span>
<span class="normal"><a href="#__codelineno-0-16">16</a></span>
<span class="normal"><a href="#__codelineno-0-17">17</a></span>
<span class="normal"><a href="#__codelineno-0-18">18</a></span>
<span class="normal"><a href="#__codelineno-0-19">19</a></span>
<span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">pl_shader_extract_features</span><span class="p">(</span><span class="n">pl_shader</span><span class="w"> </span><span class="n">sh</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">pl_color_space</span><span class="w"> </span><span class="n">csp</span><span class="p">)</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="p">{</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">sh_require</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span><span class="w"> </span><span class="n">PL_SHADER_SIG_COLOR</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">    </span><span class="n">sh_describe</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;feature extraction&quot;</span><span class="p">);</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">    </span><span class="n">pl_shader_linearize</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">csp</span><span class="p">);</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">    </span><span class="n">GLSL</span><span class="p">(</span><span class="s">&quot;// pl_shader_extract_features             </span><span class="se">\n</span><span class="s">&quot;</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">         </span><span class="s">&quot;{                                         </span><span class="se">\n</span><span class="s">&quot;</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="w">         </span><span class="s">&quot;vec3 lms = %f * &quot;</span><span class="n">$</span><span class="s">&quot; * color.rgb;          </span><span class="se">\n</span><span class="s">&quot;</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">         </span><span class="s">&quot;lms = pow(max(lms, 0.0), vec3(%f));       </span><span class="se">\n</span><span class="s">&quot;</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="w">         </span><span class="s">&quot;lms = (vec3(%f) + %f * lms)               </span><span class="se">\n</span><span class="s">&quot;</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="w">         </span><span class="s">&quot;        / (vec3(1.0) + %f * lms);         </span><span class="se">\n</span><span class="s">&quot;</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="w">         </span><span class="s">&quot;lms = pow(lms, vec3(%f));                 </span><span class="se">\n</span><span class="s">&quot;</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">         </span><span class="s">&quot;float I = dot(vec3(%f, %f, %f), lms);     </span><span class="se">\n</span><span class="s">&quot;</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="w">         </span><span class="s">&quot;color = vec4(I, 0.0, 0.0, 1.0);           </span><span class="se">\n</span><span class="s">&quot;</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="w">         </span><span class="s">&quot;}                                         </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="w">         </span><span class="n">PL_COLOR_SDR_WHITE</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">10000</span><span class="p">,</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="w">         </span><span class="n">SH_MAT3</span><span class="p">(</span><span class="n">pl_ipt_rgb2lms</span><span class="p">(</span><span class="n">pl_raw_primaries_get</span><span class="p">(</span><span class="n">csp</span><span class="p">.</span><span class="n">primaries</span><span class="p">))),</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="w">         </span><span class="n">PQ_M1</span><span class="p">,</span><span class="w"> </span><span class="n">PQ_C1</span><span class="p">,</span><span class="w"> </span><span class="n">PQ_C2</span><span class="p">,</span><span class="w"> </span><span class="n">PQ_C3</span><span class="p">,</span><span class="w"> </span><span class="n">PQ_M2</span><span class="p">,</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="w">         </span><span class="n">pl_ipt_lms2ipt</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">pl_ipt_lms2ipt</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">pl_ipt_lms2ipt</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]);</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>The special macro <code>$</code> is a stand-in for an <em>identifier</em> (<code>ident_t</code>), which is
the internal type used to pass references to loaded uniforms, descriptors and
so on:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="k">typedef</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">short</span><span class="w"> </span><span class="n">ident_t</span><span class="p">;</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="cp">#define $           &quot;_%hx&quot;</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="cp">#define NULL_IDENT  0u</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="c1">// ...</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="n">ident_t</span><span class="w"> </span><span class="nf">sh_var_mat3</span><span class="p">(</span><span class="n">pl_shader</span><span class="w"> </span><span class="n">sh</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">pl_matrix3x3</span><span class="w"> </span><span class="n">val</span><span class="p">);</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="cp">#define SH_MAT3(val) sh_var_mat3(sh, &quot;mat&quot;, val)</span>
</code></pre></div>
<p>In general, constants in libplacebo are divided into three categories:</p>
<h3 id="literal-shader-constants">Literal shader constants</h3>
<p>These are values that are expected to change very infrequently (or never), or
for which we want to generate a different shader variant per value. Such values
should be directly formatted as numbers into the shader text: <code>%d</code>, <code>%f</code> and so
on. This is commonly used for array sizes, constants that depend only on
hardware limits, constants that never change (but which have a friendly name,
like <code>PQ_C2</code> above), and so on.</p>
<p>As an example, the debanding iterations weights are hard-coded like this,
because the debanding shader is expected to change as a result of a different
number of iterations anyway:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-2-10">10</a></span>
<span class="normal"><a href="#__codelineno-2-11">11</a></span>
<span class="normal"><a href="#__codelineno-2-12">12</a></span>
<span class="normal"><a href="#__codelineno-2-13">13</a></span>
<span class="normal"><a href="#__codelineno-2-14">14</a></span>
<span class="normal"><a href="#__codelineno-2-15">15</a></span>
<span class="normal"><a href="#__codelineno-2-16">16</a></span>
<span class="normal"><a href="#__codelineno-2-17">17</a></span>
<span class="normal"><a href="#__codelineno-2-18">18</a></span>
<span class="normal"><a href="#__codelineno-2-19">19</a></span>
<span class="normal"><a href="#__codelineno-2-20">20</a></span>
<span class="normal"><a href="#__codelineno-2-21">21</a></span>
<span class="normal"><a href="#__codelineno-2-22">22</a></span>
<span class="normal"><a href="#__codelineno-2-23">23</a></span>
<span class="normal"><a href="#__codelineno-2-24">24</a></span>
<span class="normal"><a href="#__codelineno-2-25">25</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="c1">// For each iteration, compute the average at a given distance and</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="c1">// pick it instead of the color if the difference is below the threshold.</span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">params</span><span class="o">-&gt;</span><span class="n">iterations</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="w">    </span><span class="n">GLSL</span><span class="p">(</span><span class="c1">// Compute a random angle and distance</span>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="w">         </span><span class="s">&quot;d = &quot;</span><span class="n">$</span><span class="s">&quot;.xy * vec2(%d.0 * &quot;</span><span class="n">$</span><span class="s">&quot;, %f);    </span><span class="se">\n</span><span class="s">&quot;</span><span class="w"> </span><span class="c1">// (1)</span>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="w">         </span><span class="s">&quot;d = d.x * vec2(cos(d.y), sin(d.y));   </span><span class="se">\n</span><span class="s">&quot;</span>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="w">         </span><span class="c1">// Sample at quarter-turn intervals around the source pixel</span>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="w">         </span><span class="s">&quot;avg = T(0.0);                         </span><span class="se">\n</span><span class="s">&quot;</span>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="w">         </span><span class="s">&quot;avg += GET(+d.x, +d.y);               </span><span class="se">\n</span><span class="s">&quot;</span>
<a id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="w">         </span><span class="s">&quot;avg += GET(-d.x, +d.y);               </span><span class="se">\n</span><span class="s">&quot;</span>
<a id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="w">         </span><span class="s">&quot;avg += GET(-d.x, -d.y);               </span><span class="se">\n</span><span class="s">&quot;</span>
<a id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="w">         </span><span class="s">&quot;avg += GET(+d.x, -d.y);               </span><span class="se">\n</span><span class="s">&quot;</span>
<a id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="w">         </span><span class="s">&quot;avg *= 0.25;                          </span><span class="se">\n</span><span class="s">&quot;</span>
<a id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="w">         </span><span class="c1">// Compare the (normalized) average against the pixel</span>
<a id="__codelineno-2-15" name="__codelineno-2-15"></a><span class="w">         </span><span class="s">&quot;diff = abs(res - avg);                </span><span class="se">\n</span><span class="s">&quot;</span>
<a id="__codelineno-2-16" name="__codelineno-2-16"></a><span class="w">         </span><span class="s">&quot;bound = T(&quot;</span><span class="n">$</span><span class="s">&quot; / %d.0);                </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<a id="__codelineno-2-17" name="__codelineno-2-17"></a><span class="w">         </span><span class="n">prng</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">radius</span><span class="p">,</span><span class="w"> </span><span class="n">M_PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<a id="__codelineno-2-18" name="__codelineno-2-18"></a><span class="w">         </span><span class="n">threshold</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
<a id="__codelineno-2-19" name="__codelineno-2-19"></a>
<a id="__codelineno-2-20" name="__codelineno-2-20"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">num_comps</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-21" name="__codelineno-2-21"></a><span class="w">        </span><span class="n">GLSL</span><span class="p">(</span><span class="s">&quot;res = mix(avg, res, greaterThan(diff, bound)); </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="__codelineno-2-22" name="__codelineno-2-22"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-23" name="__codelineno-2-23"></a><span class="w">        </span><span class="n">GLSL</span><span class="p">(</span><span class="s">&quot;res = mix(avg, res, diff &gt; bound); </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="__codelineno-2-24" name="__codelineno-2-24"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-2-25" name="__codelineno-2-25"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ol>
<li>The <code>%d.0</code> here corresponds to the iteration index <code>i</code>, while the <code>%f</code>
    corresponds to the fixed constant <code>M_PI * 2</code>.</li>
</ol>
<h3 id="specializable-shader-constants">Specializable shader constants</h3>
<p>These are used for tunable parameters that are expected to change infrequently
during normal playback. These constitute by far the biggest category, and most
parameters coming from the various <code>_params</code> structs should be loaded like
this.</p>
<p>They are loaded using the <code>sh_const_*()</code> functions, which generate a
specialization constant on supported platforms, falling back to a literal
shader <code>#define</code> otherwise. For anoymous parameters, you can use the
short-hands <code>SH_FLOAT</code>, <code>SH_INT</code> etc.:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="n">ident_t</span><span class="w"> </span><span class="nf">sh_const_int</span><span class="p">(</span><span class="n">pl_shader</span><span class="w"> </span><span class="n">sh</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">val</span><span class="p">);</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="n">ident_t</span><span class="w"> </span><span class="nf">sh_const_uint</span><span class="p">(</span><span class="n">pl_shader</span><span class="w"> </span><span class="n">sh</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">val</span><span class="p">);</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="n">ident_t</span><span class="w"> </span><span class="nf">sh_const_float</span><span class="p">(</span><span class="n">pl_shader</span><span class="w"> </span><span class="n">sh</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">val</span><span class="p">);</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="cp">#define SH_INT(val)     sh_const_int(sh, &quot;const&quot;, val)</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="cp">#define SH_UINT(val)    sh_const_uint(sh, &quot;const&quot;, val)</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="cp">#define SH_FLOAT(val)   sh_const_float(sh, &quot;const&quot;, val)</span>
</code></pre></div>
<p>Here is an example of them in action:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-4-10">10</a></span>
<span class="normal"><a href="#__codelineno-4-11">11</a></span>
<span class="normal"><a href="#__codelineno-4-12">12</a></span>
<span class="normal"><a href="#__codelineno-4-13">13</a></span>
<span class="normal"><a href="#__codelineno-4-14">14</a></span>
<span class="normal"><a href="#__codelineno-4-15">15</a></span>
<span class="normal"><a href="#__codelineno-4-16">16</a></span>
<span class="normal"><a href="#__codelineno-4-17">17</a></span>
<span class="normal"><a href="#__codelineno-4-18">18</a></span>
<span class="normal"><a href="#__codelineno-4-19">19</a></span>
<span class="normal"><a href="#__codelineno-4-20">20</a></span>
<span class="normal"><a href="#__codelineno-4-21">21</a></span>
<span class="normal"><a href="#__codelineno-4-22">22</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">pl_shader_sigmoidize</span><span class="p">(</span><span class="n">pl_shader</span><span class="w"> </span><span class="n">sh</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">pl_sigmoid_params</span><span class="w"> </span><span class="o">*</span><span class="n">params</span><span class="p">)</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="p">{</span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">sh_require</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span><span class="w"> </span><span class="n">PL_SHADER_SIG_COLOR</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a>
<a id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="w">    </span><span class="n">params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PL_DEF</span><span class="p">(</span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pl_sigmoid_default_params</span><span class="p">);</span>
<a id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">center</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PL_DEF</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">center</span><span class="p">,</span><span class="w"> </span><span class="mf">0.75</span><span class="p">);</span>
<a id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">slope</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">PL_DEF</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">slope</span><span class="p">,</span><span class="w"> </span><span class="mf">6.5</span><span class="p">);</span>
<a id="__codelineno-4-9" name="__codelineno-4-9"></a>
<a id="__codelineno-4-10" name="__codelineno-4-10"></a><span class="w">    </span><span class="c1">// This function needs to go through (0,0) and (1,1), so we compute the</span>
<a id="__codelineno-4-11" name="__codelineno-4-11"></a><span class="w">    </span><span class="c1">// values at 1 and 0, and then scale/shift them, respectively.</span>
<a id="__codelineno-4-12" name="__codelineno-4-12"></a><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">expf</span><span class="p">(</span><span class="n">slope</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">center</span><span class="p">));</span>
<a id="__codelineno-4-13" name="__codelineno-4-13"></a><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">scale</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">expf</span><span class="p">(</span><span class="n">slope</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">center</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)))</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">offset</span><span class="p">;</span>
<a id="__codelineno-4-14" name="__codelineno-4-14"></a>
<a id="__codelineno-4-15" name="__codelineno-4-15"></a><span class="w">    </span><span class="n">GLSL</span><span class="p">(</span><span class="s">&quot;// pl_shader_sigmoidize                               </span><span class="se">\n</span><span class="s">&quot;</span>
<a id="__codelineno-4-16" name="__codelineno-4-16"></a><span class="w">         </span><span class="s">&quot;color = clamp(color, 0.0, 1.0);                       </span><span class="se">\n</span><span class="s">&quot;</span>
<a id="__codelineno-4-17" name="__codelineno-4-17"></a><span class="w">         </span><span class="s">&quot;color = vec4(&quot;</span><span class="n">$</span><span class="s">&quot;) - vec4(&quot;</span><span class="n">$</span><span class="s">&quot;) *                       </span><span class="se">\n</span><span class="s">&quot;</span>
<a id="__codelineno-4-18" name="__codelineno-4-18"></a><span class="w">         </span><span class="s">&quot;    log(vec4(1.0) / (color * vec4(&quot;</span><span class="n">$</span><span class="s">&quot;) + vec4(&quot;</span><span class="n">$</span><span class="s">&quot;))   </span><span class="se">\n</span><span class="s">&quot;</span>
<a id="__codelineno-4-19" name="__codelineno-4-19"></a><span class="w">         </span><span class="s">&quot;        - vec4(1.0));                                 </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<a id="__codelineno-4-20" name="__codelineno-4-20"></a><span class="w">         </span><span class="n">SH_FLOAT</span><span class="p">(</span><span class="n">center</span><span class="p">),</span><span class="w"> </span><span class="n">SH_FLOAT</span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">slope</span><span class="p">),</span>
<a id="__codelineno-4-21" name="__codelineno-4-21"></a><span class="w">         </span><span class="n">SH_FLOAT</span><span class="p">(</span><span class="n">scale</span><span class="p">),</span><span class="w"> </span><span class="n">SH_FLOAT</span><span class="p">(</span><span class="n">offset</span><span class="p">));</span>
<a id="__codelineno-4-22" name="__codelineno-4-22"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>The advantage of this type of shader constant is that they will be
transparently replaced by dynamic uniforms whenever
<code>pl_render_params.dynamic_constants</code> is true, which allows the renderer to
respond more instantly to changes in the parameters (e.g. as a result of a user
dragging a slider around). During "normal" playback, they will then be
"promoted" to actual shader constants to prevent them from taking up registers.</p>
<h3 id="dynamic-variables">Dynamic variables</h3>
<p>For anything else, e.g. variables which are expected to change very frequently,
you can use the generic <code>sh_var()</code> mechanism, which sends constants either as
elements of a uniform buffer, or directly as push constants:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="n">ident_t</span><span class="w"> </span><span class="nf">sh_var_int</span><span class="p">(</span><span class="n">pl_shader</span><span class="w"> </span><span class="n">sh</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">dynamic</span><span class="p">);</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="n">ident_t</span><span class="w"> </span><span class="nf">sh_var_uint</span><span class="p">(</span><span class="n">pl_shader</span><span class="w"> </span><span class="n">sh</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">dynamic</span><span class="p">);</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="n">ident_t</span><span class="w"> </span><span class="nf">sh_var_float</span><span class="p">(</span><span class="n">pl_shader</span><span class="w"> </span><span class="n">sh</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">dynamic</span><span class="p">);</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="cp">#define SH_INT_DYN(val)   sh_var_int(sh, &quot;const&quot;, val, true)</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="cp">#define SH_UINT_DYN(val)  sh_var_uint(sh, &quot;const&quot;, val, true)</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="cp">#define SH_FLOAT_DYN(val) sh_var_float(sh, &quot;const&quot;, val, true)</span>
</code></pre></div>
<p>These are used primarily when a variable is expected to change very frequently,
e.g. as a result of randomness, or for constants which depend on dynamically
computed, source-dependent variables (e.g. input frame characteristics):</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-6-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-6-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-6-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-6-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-6-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-6-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-6-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-6-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-6-10">10</a></span>
<span class="normal"><a href="#__codelineno-6-11">11</a></span>
<span class="normal"><a href="#__codelineno-6-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">show_clipping</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">eps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1e-6f</span><span class="p">;</span>
<a id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="w">    </span><span class="n">GLSL</span><span class="p">(</span><span class="s">&quot;bool clip_hi, clip_lo;                            </span><span class="se">\n</span><span class="s">&quot;</span>
<a id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="w">         </span><span class="s">&quot;clip_hi = any(greaterThan(color.rgb, vec3(&quot;</span><span class="n">$</span><span class="s">&quot;))); </span><span class="se">\n</span><span class="s">&quot;</span>
<a id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="w">         </span><span class="s">&quot;clip_lo = any(lessThan(color.rgb, vec3(&quot;</span><span class="n">$</span><span class="s">&quot;)));    </span><span class="se">\n</span><span class="s">&quot;</span>
<a id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="w">         </span><span class="s">&quot;clip_hi = clip_hi || ipt.x &gt; &quot;</span><span class="n">$</span><span class="s">&quot;;                 </span><span class="se">\n</span><span class="s">&quot;</span>
<a id="__codelineno-6-7" name="__codelineno-6-7"></a><span class="w">         </span><span class="s">&quot;clip_lo = clip_lo || ipt.x &lt; &quot;</span><span class="n">$</span><span class="s">&quot;;                 </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<a id="__codelineno-6-8" name="__codelineno-6-8"></a><span class="w">         </span><span class="n">SH_FLOAT_DYN</span><span class="p">(</span><span class="n">pl_hdr_rescale</span><span class="p">(</span><span class="n">PL_HDR_PQ</span><span class="p">,</span><span class="w"> </span><span class="n">PL_HDR_NORM</span><span class="p">,</span><span class="w"> </span><span class="n">tone</span><span class="p">.</span><span class="n">input_max</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">eps</span><span class="p">),</span>
<a id="__codelineno-6-9" name="__codelineno-6-9"></a><span class="w">         </span><span class="n">SH_FLOAT</span><span class="p">(</span><span class="n">pl_hdr_rescale</span><span class="p">(</span><span class="n">PL_HDR_PQ</span><span class="p">,</span><span class="w"> </span><span class="n">PL_HDR_NORM</span><span class="p">,</span><span class="w"> </span><span class="n">tone</span><span class="p">.</span><span class="n">input_min</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">eps</span><span class="p">),</span>
<a id="__codelineno-6-10" name="__codelineno-6-10"></a><span class="w">         </span><span class="n">SH_FLOAT_DYN</span><span class="p">(</span><span class="n">tone</span><span class="p">.</span><span class="n">input_max</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">eps</span><span class="p">),</span>
<a id="__codelineno-6-11" name="__codelineno-6-11"></a><span class="w">         </span><span class="n">SH_FLOAT</span><span class="p">(</span><span class="n">tone</span><span class="p">.</span><span class="n">input_min</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">eps</span><span class="p">));</span>
<a id="__codelineno-6-12" name="__codelineno-6-12"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h3 id="shader-sections-glsl-glslh-glslf">Shader sections (GLSL, GLSLH, GLSLF)</h3>
<p>Shader macros come in three main flavors, depending on where the resulting text
should be formatted:</p>
<ul>
<li><code>GLSL</code>: Expanded in the scope of the current <code>main</code> function,
  and is related to code directly processing the current pixel value.</li>
<li><code>GLSLH</code>: Printed to the 'header', before the first function, but after
  variables, uniforms etc. This is used for global definitions, helper
  functions, shared memory variables, and so on.</li>
<li><code>GLSLF</code>: Printed to the <code>footer</code>, which is always at the end of the current
  <code>main</code> function, but before returning to the caller / writing to the
  framebuffer. Used to e.g. update SSBO state in preparation for the next
  frame.</li>
</ul>
<p>Finally, there is a fourth category <code>GLSLP</code> (prelude), which is currently only
used internally to generate preambles during e.g. compute shader translation.</p>
<h2 id="new-pragma-glsl-macro">New #pragma GLSL macro</h2>
<p>Starting with libplacebo v6, the internal shader system has been augmented by a
custom macro preprocessor, which is designed to ease the boilerplate of writing
shaders (and also strip redundant whitespace from generated shaders). The code
for this is found in the
<a href="https://code.videolan.org/videolan/libplacebo/-/tree/master/tools/glsl_preproc">tools/glsl_preproc</a>
directory.</p>
<p>In a nutshell, this allows us to embed GLSL snippets directly as <code>#pragma GLSL</code>
macros (resp. <code>#pragma GLSLH</code>, <code>#pragma GLSLF</code>):</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-7-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-7-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-7-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-7-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-7-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-7-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-7-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-7-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-7-10">10</a></span>
<span class="normal"><a href="#__codelineno-7-11">11</a></span>
<span class="normal"><a href="#__codelineno-7-12">12</a></span>
<span class="normal"><a href="#__codelineno-7-13">13</a></span>
<span class="normal"><a href="#__codelineno-7-14">14</a></span>
<span class="normal"><a href="#__codelineno-7-15">15</a></span>
<span class="normal"><a href="#__codelineno-7-16">16</a></span>
<span class="normal"><a href="#__codelineno-7-17">17</a></span>
<span class="normal"><a href="#__codelineno-7-18">18</a></span>
<span class="normal"><a href="#__codelineno-7-19">19</a></span>
<span class="normal"><a href="#__codelineno-7-20">20</a></span>
<span class="normal"><a href="#__codelineno-7-21">21</a></span>
<span class="normal"><a href="#__codelineno-7-22">22</a></span>
<span class="normal"><a href="#__codelineno-7-23">23</a></span>
<span class="normal"><a href="#__codelineno-7-24">24</a></span>
<span class="normal"><a href="#__codelineno-7-25">25</a></span>
<span class="normal"><a href="#__codelineno-7-26">26</a></span>
<span class="normal"><a href="#__codelineno-7-27">27</a></span>
<span class="normal"><a href="#__codelineno-7-28">28</a></span>
<span class="normal"><a href="#__codelineno-7-29">29</a></span>
<span class="normal"><a href="#__codelineno-7-30">30</a></span>
<span class="normal"><a href="#__codelineno-7-31">31</a></span>
<span class="normal"><a href="#__codelineno-7-32">32</a></span>
<span class="normal"><a href="#__codelineno-7-33">33</a></span>
<span class="normal"><a href="#__codelineno-7-34">34</a></span>
<span class="normal"><a href="#__codelineno-7-35">35</a></span>
<span class="normal"><a href="#__codelineno-7-36">36</a></span>
<span class="normal"><a href="#__codelineno-7-37">37</a></span>
<span class="normal"><a href="#__codelineno-7-38">38</a></span>
<span class="normal"><a href="#__codelineno-7-39">39</a></span>
<span class="normal"><a href="#__codelineno-7-40">40</a></span>
<span class="normal"><a href="#__codelineno-7-41">41</a></span>
<span class="normal"><a href="#__codelineno-7-42">42</a></span>
<span class="normal"><a href="#__codelineno-7-43">43</a></span>
<span class="normal"><a href="#__codelineno-7-44">44</a></span>
<span class="normal"><a href="#__codelineno-7-45">45</a></span>
<span class="normal"><a href="#__codelineno-7-46">46</a></span>
<span class="normal"><a href="#__codelineno-7-47">47</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="kt">bool</span><span class="w"> </span><span class="nf">pl_shader_sample_bicubic</span><span class="p">(</span><span class="n">pl_shader</span><span class="w"> </span><span class="n">sh</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">pl_sample_src</span><span class="w"> </span><span class="o">*</span><span class="n">src</span><span class="p">)</span>
<a id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="p">{</span>
<a id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="w">    </span><span class="n">ident_t</span><span class="w"> </span><span class="n">tex</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">pt</span><span class="p">;</span>
<a id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">rx</span><span class="p">,</span><span class="w"> </span><span class="n">ry</span><span class="p">,</span><span class="w"> </span><span class="n">scale</span><span class="p">;</span>
<a id="__codelineno-7-5" name="__codelineno-7-5"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">setup_src</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span><span class="w"> </span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tex</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pt</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">rx</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ry</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">scale</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="n">LINEAR</span><span class="p">))</span>
<a id="__codelineno-7-6" name="__codelineno-7-6"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<a id="__codelineno-7-7" name="__codelineno-7-7"></a>
<a id="__codelineno-7-8" name="__codelineno-7-8"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">ry</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-9" name="__codelineno-7-9"></a><span class="w">        </span><span class="n">PL_TRACE</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Using fast bicubic sampling when downscaling. This &quot;</span>
<a id="__codelineno-7-10" name="__codelineno-7-10"></a><span class="w">                 </span><span class="s">&quot;will most likely result in nasty aliasing!&quot;</span><span class="p">);</span>
<a id="__codelineno-7-11" name="__codelineno-7-11"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-7-12" name="__codelineno-7-12"></a>
<a id="__codelineno-7-13" name="__codelineno-7-13"></a><span class="w">    </span><span class="c1">// Explanation of how bicubic scaling with only 4 texel fetches is done:</span>
<a id="__codelineno-7-14" name="__codelineno-7-14"></a><span class="w">    </span><span class="c1">//   http://www.mate.tue.nl/mate/pdfs/10318.pdf</span>
<a id="__codelineno-7-15" name="__codelineno-7-15"></a><span class="w">    </span><span class="c1">//   &#39;Efficient GPU-Based Texture Interpolation using Uniform B-Splines&#39;</span>
<a id="__codelineno-7-16" name="__codelineno-7-16"></a>
<a id="__codelineno-7-17" name="__codelineno-7-17"></a><span class="w">    </span><span class="n">sh_describe</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;bicubic&quot;</span><span class="p">);</span>
<a id="__codelineno-7-18" name="__codelineno-7-18"></a><span class="cp">#pragma GLSL </span><span class="cm">/* pl_shader_sample_bicubic */</span><span class="cp">         \</span>
<a id="__codelineno-7-19" name="__codelineno-7-19"></a><span class="cp">    vec4 color;                                     \</span>
<a id="__codelineno-7-20" name="__codelineno-7-20"></a><span class="cp">    {                                               \</span>
<a id="__codelineno-7-21" name="__codelineno-7-21"></a><span class="cp">    vec2 pos = $pos;                                \</span>
<a id="__codelineno-7-22" name="__codelineno-7-22"></a><span class="cp">    vec2 size = vec2(textureSize($tex, 0));         \</span>
<a id="__codelineno-7-23" name="__codelineno-7-23"></a><span class="cp">    vec2 frac  = fract(pos * size + vec2(0.5));     \</span>
<a id="__codelineno-7-24" name="__codelineno-7-24"></a><span class="cp">    vec2 frac2 = frac * frac;                       \</span>
<a id="__codelineno-7-25" name="__codelineno-7-25"></a><span class="cp">    vec2 inv   = vec2(1.0) - frac;                  \</span>
<a id="__codelineno-7-26" name="__codelineno-7-26"></a><span class="cp">    vec2 inv2  = inv * inv;                         \</span>
<a id="__codelineno-7-27" name="__codelineno-7-27"></a><span class="cp">    </span><span class="cm">/* compute basis spline */</span><span class="cp">                      \</span>
<a id="__codelineno-7-28" name="__codelineno-7-28"></a><span class="cp">    vec2 w0 = 1.0/6.0 * inv2 * inv;                 \</span>
<a id="__codelineno-7-29" name="__codelineno-7-29"></a><span class="cp">    vec2 w1 = 2.0/3.0 - 0.5 * frac2 * (2.0 - frac); \</span>
<a id="__codelineno-7-30" name="__codelineno-7-30"></a><span class="cp">    vec2 w2 = 2.0/3.0 - 0.5 * inv2  * (2.0 - inv);  \</span>
<a id="__codelineno-7-31" name="__codelineno-7-31"></a><span class="cp">    vec2 w3 = 1.0/6.0 * frac2 * frac;               \</span>
<a id="__codelineno-7-32" name="__codelineno-7-32"></a><span class="cp">    vec4 g = vec4(w0 + w1, w2 + w3);                \</span>
<a id="__codelineno-7-33" name="__codelineno-7-33"></a><span class="cp">    vec4 h = vec4(w1, w3) / g + inv.xyxy;           \</span>
<a id="__codelineno-7-34" name="__codelineno-7-34"></a><span class="cp">    h.xy -= vec2(2.0);                              \</span>
<a id="__codelineno-7-35" name="__codelineno-7-35"></a><span class="cp">    </span><span class="cm">/* sample four corners, then interpolate */</span><span class="cp">     \</span>
<a id="__codelineno-7-36" name="__codelineno-7-36"></a><span class="cp">    vec4 p = pos.xyxy + $pt.xyxy * h;               \</span>
<a id="__codelineno-7-37" name="__codelineno-7-37"></a><span class="cp">    vec4 c00 = textureLod($tex, p.xy, 0.0);         \</span>
<a id="__codelineno-7-38" name="__codelineno-7-38"></a><span class="cp">    vec4 c01 = textureLod($tex, p.xw, 0.0);         \</span>
<a id="__codelineno-7-39" name="__codelineno-7-39"></a><span class="cp">    vec4 c0 = mix(c01, c00, g.y);                   \</span>
<a id="__codelineno-7-40" name="__codelineno-7-40"></a><span class="cp">    vec4 c10 = textureLod($tex, p.zy, 0.0);         \</span>
<a id="__codelineno-7-41" name="__codelineno-7-41"></a><span class="cp">    vec4 c11 = textureLod($tex, p.zw, 0.0);         \</span>
<a id="__codelineno-7-42" name="__codelineno-7-42"></a><span class="cp">    vec4 c1 = mix(c11, c10, g.y);                   \</span>
<a id="__codelineno-7-43" name="__codelineno-7-43"></a><span class="cp">    color = ${float:scale} * mix(c1, c0, g.x);      \</span>
<a id="__codelineno-7-44" name="__codelineno-7-44"></a><span class="cp">    }</span>
<a id="__codelineno-7-45" name="__codelineno-7-45"></a>
<a id="__codelineno-7-46" name="__codelineno-7-46"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<a id="__codelineno-7-47" name="__codelineno-7-47"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>This gets transformed, by the GLSL macro preprocessor, into an optimized shader
template invocation like the following:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-8-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-8-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-8-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-8-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-8-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-8-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-8-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-8-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-8-10">10</a></span>
<span class="normal"><a href="#__codelineno-8-11">11</a></span>
<span class="normal"><a href="#__codelineno-8-12">12</a></span>
<span class="normal"><a href="#__codelineno-8-13">13</a></span>
<span class="normal"><a href="#__codelineno-8-14">14</a></span>
<span class="normal"><a href="#__codelineno-8-15">15</a></span>
<span class="normal"><a href="#__codelineno-8-16">16</a></span>
<span class="normal"><a href="#__codelineno-8-17">17</a></span>
<span class="normal"><a href="#__codelineno-8-18">18</a></span>
<span class="normal"><a href="#__codelineno-8-19">19</a></span>
<span class="normal"><a href="#__codelineno-8-20">20</a></span>
<span class="normal"><a href="#__codelineno-8-21">21</a></span>
<span class="normal"><a href="#__codelineno-8-22">22</a></span>
<span class="normal"><a href="#__codelineno-8-23">23</a></span>
<span class="normal"><a href="#__codelineno-8-24">24</a></span>
<span class="normal"><a href="#__codelineno-8-25">25</a></span>
<span class="normal"><a href="#__codelineno-8-26">26</a></span>
<span class="normal"><a href="#__codelineno-8-27">27</a></span>
<span class="normal"><a href="#__codelineno-8-28">28</a></span>
<span class="normal"><a href="#__codelineno-8-29">29</a></span>
<span class="normal"><a href="#__codelineno-8-30">30</a></span>
<span class="normal"><a href="#__codelineno-8-31">31</a></span>
<span class="normal"><a href="#__codelineno-8-32">32</a></span>
<span class="normal"><a href="#__codelineno-8-33">33</a></span>
<span class="normal"><a href="#__codelineno-8-34">34</a></span>
<span class="normal"><a href="#__codelineno-8-35">35</a></span>
<span class="normal"><a href="#__codelineno-8-36">36</a></span>
<span class="normal"><a href="#__codelineno-8-37">37</a></span>
<span class="normal"><a href="#__codelineno-8-38">38</a></span>
<span class="normal"><a href="#__codelineno-8-39">39</a></span>
<span class="normal"><a href="#__codelineno-8-40">40</a></span>
<span class="normal"><a href="#__codelineno-8-41">41</a></span>
<span class="normal"><a href="#__codelineno-8-42">42</a></span>
<span class="normal"><a href="#__codelineno-8-43">43</a></span>
<span class="normal"><a href="#__codelineno-8-44">44</a></span>
<span class="normal"><a href="#__codelineno-8-45">45</a></span>
<span class="normal"><a href="#__codelineno-8-46">46</a></span>
<span class="normal"><a href="#__codelineno-8-47">47</a></span>
<span class="normal"><a href="#__codelineno-8-48">48</a></span>
<span class="normal"><a href="#__codelineno-8-49">49</a></span>
<span class="normal"><a href="#__codelineno-8-50">50</a></span>
<span class="normal"><a href="#__codelineno-8-51">51</a></span>
<span class="normal"><a href="#__codelineno-8-52">52</a></span>
<span class="normal"><a href="#__codelineno-8-53">53</a></span>
<span class="normal"><a href="#__codelineno-8-54">54</a></span>
<span class="normal"><a href="#__codelineno-8-55">55</a></span>
<span class="normal"><a href="#__codelineno-8-56">56</a></span>
<span class="normal"><a href="#__codelineno-8-57">57</a></span>
<span class="normal"><a href="#__codelineno-8-58">58</a></span>
<span class="normal"><a href="#__codelineno-8-59">59</a></span>
<span class="normal"><a href="#__codelineno-8-60">60</a></span>
<span class="normal"><a href="#__codelineno-8-61">61</a></span>
<span class="normal"><a href="#__codelineno-8-62">62</a></span>
<span class="normal"><a href="#__codelineno-8-63">63</a></span>
<span class="normal"><a href="#__codelineno-8-64">64</a></span>
<span class="normal"><a href="#__codelineno-8-65">65</a></span>
<span class="normal"><a href="#__codelineno-8-66">66</a></span>
<span class="normal"><a href="#__codelineno-8-67">67</a></span>
<span class="normal"><a href="#__codelineno-8-68">68</a></span>
<span class="normal"><a href="#__codelineno-8-69">69</a></span>
<span class="normal"><a href="#__codelineno-8-70">70</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="p">{</span>
<a id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="w">    </span><span class="n">sh_describe</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;bicubic&quot;</span><span class="p">);</span>
<a id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">__attribute__</span><span class="p">((</span><span class="n">__packed__</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="w">        </span><span class="n">ident_t</span><span class="w"> </span><span class="n">pos</span><span class="p">;</span>
<a id="__codelineno-8-6" name="__codelineno-8-6"></a><span class="w">        </span><span class="n">ident_t</span><span class="w"> </span><span class="n">tex</span><span class="p">;</span>
<a id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="w">        </span><span class="n">ident_t</span><span class="w"> </span><span class="n">pt</span><span class="p">;</span>
<a id="__codelineno-8-8" name="__codelineno-8-8"></a><span class="w">        </span><span class="n">ident_t</span><span class="w"> </span><span class="n">scale</span><span class="p">;</span>
<a id="__codelineno-8-9" name="__codelineno-8-9"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">_glsl_330_args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-10" name="__codelineno-8-10"></a><span class="w">        </span><span class="p">.</span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos</span><span class="p">,</span>
<a id="__codelineno-8-11" name="__codelineno-8-11"></a><span class="w">        </span><span class="p">.</span><span class="n">tex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tex</span><span class="p">,</span>
<a id="__codelineno-8-12" name="__codelineno-8-12"></a><span class="w">        </span><span class="p">.</span><span class="n">pt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pt</span><span class="p">,</span>
<a id="__codelineno-8-13" name="__codelineno-8-13"></a><span class="w">        </span><span class="p">.</span><span class="n">scale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sh_const_float</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;scale&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">scale</span><span class="p">),</span>
<a id="__codelineno-8-14" name="__codelineno-8-14"></a><span class="w">    </span><span class="p">};</span>
<a id="__codelineno-8-15" name="__codelineno-8-15"></a><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="nf">_glsl_330_fn</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">pl_str</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">);</span>
<a id="__codelineno-8-16" name="__codelineno-8-16"></a><span class="w">    </span><span class="n">pl_str_builder_append</span><span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">[</span><span class="n">SH_BUF_BODY</span><span class="p">],</span><span class="w"> </span><span class="n">_glsl_330_fn</span><span class="p">,</span>
<a id="__codelineno-8-17" name="__codelineno-8-17"></a><span class="w">                          </span><span class="o">&amp;</span><span class="n">_glsl_330_args</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">_glsl_330_args</span><span class="p">));</span>
<a id="__codelineno-8-18" name="__codelineno-8-18"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-8-19" name="__codelineno-8-19"></a><span class="p">}</span>
<a id="__codelineno-8-20" name="__codelineno-8-20"></a>
<a id="__codelineno-8-21" name="__codelineno-8-21"></a><span class="kt">size_t</span><span class="w"> </span><span class="n">_glsl_330_fn</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">alloc</span><span class="p">,</span><span class="w"> </span><span class="n">pl_str</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<a id="__codelineno-8-22" name="__codelineno-8-22"></a><span class="p">{</span>
<a id="__codelineno-8-23" name="__codelineno-8-23"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">__attribute__</span><span class="p">((</span><span class="n">__packed__</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-24" name="__codelineno-8-24"></a><span class="w">        </span><span class="n">ident_t</span><span class="w"> </span><span class="n">pos</span><span class="p">;</span>
<a id="__codelineno-8-25" name="__codelineno-8-25"></a><span class="w">        </span><span class="n">ident_t</span><span class="w"> </span><span class="n">tex</span><span class="p">;</span>
<a id="__codelineno-8-26" name="__codelineno-8-26"></a><span class="w">        </span><span class="n">ident_t</span><span class="w"> </span><span class="n">pt</span><span class="p">;</span>
<a id="__codelineno-8-27" name="__codelineno-8-27"></a><span class="w">        </span><span class="n">ident_t</span><span class="w"> </span><span class="n">scale</span><span class="p">;</span>
<a id="__codelineno-8-28" name="__codelineno-8-28"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">vars</span><span class="p">;</span>
<a id="__codelineno-8-29" name="__codelineno-8-29"></a><span class="w">    </span><span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vars</span><span class="p">,</span><span class="w"> </span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">vars</span><span class="p">));</span>
<a id="__codelineno-8-30" name="__codelineno-8-30"></a>
<a id="__codelineno-8-31" name="__codelineno-8-31"></a><span class="w">    </span><span class="n">pl_str_append_asprintf_c</span><span class="p">(</span><span class="n">alloc</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span>
<a id="__codelineno-8-32" name="__codelineno-8-32"></a><span class="w">        </span><span class="s">&quot;/* pl_shader_sample_bicubic */</span><span class="se">\n</span><span class="s">&quot;</span>
<a id="__codelineno-8-33" name="__codelineno-8-33"></a><span class="w">        </span><span class="s">&quot;    vec4 color;</span><span class="se">\n</span><span class="s">&quot;</span>
<a id="__codelineno-8-34" name="__codelineno-8-34"></a><span class="w">        </span><span class="s">&quot;    {</span><span class="se">\n</span><span class="s">&quot;</span>
<a id="__codelineno-8-35" name="__codelineno-8-35"></a><span class="w">        </span><span class="s">&quot;    vec2 pos = /*pos*/_%hx;</span><span class="se">\n</span><span class="s">&quot;</span>
<a id="__codelineno-8-36" name="__codelineno-8-36"></a><span class="w">        </span><span class="s">&quot;    vec2 size = vec2(textureSize(/*tex*/_%hx, 0));</span><span class="se">\n</span><span class="s">&quot;</span>
<a id="__codelineno-8-37" name="__codelineno-8-37"></a><span class="w">        </span><span class="s">&quot;    vec2 frac  = fract(pos * size + vec2(0.5));</span><span class="se">\n</span><span class="s">&quot;</span>
<a id="__codelineno-8-38" name="__codelineno-8-38"></a><span class="w">        </span><span class="s">&quot;    vec2 frac2 = frac * frac;</span><span class="se">\n</span><span class="s">&quot;</span>
<a id="__codelineno-8-39" name="__codelineno-8-39"></a><span class="w">        </span><span class="s">&quot;    vec2 inv   = vec2(1.0) - frac;</span><span class="se">\n</span><span class="s">&quot;</span>
<a id="__codelineno-8-40" name="__codelineno-8-40"></a><span class="w">        </span><span class="s">&quot;    vec2 inv2  = inv * inv;</span><span class="se">\n</span><span class="s">&quot;</span>
<a id="__codelineno-8-41" name="__codelineno-8-41"></a><span class="w">        </span><span class="s">&quot;    /* compute basis spline */</span><span class="se">\n</span><span class="s">&quot;</span>
<a id="__codelineno-8-42" name="__codelineno-8-42"></a><span class="w">        </span><span class="s">&quot;    vec2 w0 = 1.0/6.0 * inv2 * inv;</span><span class="se">\n</span><span class="s">&quot;</span>
<a id="__codelineno-8-43" name="__codelineno-8-43"></a><span class="w">        </span><span class="s">&quot;    vec2 w1 = 2.0/3.0 - 0.5 * frac2 * (2.0 - frac);</span><span class="se">\n</span><span class="s">&quot;</span>
<a id="__codelineno-8-44" name="__codelineno-8-44"></a><span class="w">        </span><span class="s">&quot;    vec2 w2 = 2.0/3.0 - 0.5 * inv2  * (2.0 - inv);</span><span class="se">\n</span><span class="s">&quot;</span>
<a id="__codelineno-8-45" name="__codelineno-8-45"></a><span class="w">        </span><span class="s">&quot;    vec2 w3 = 1.0/6.0 * frac2 * frac;</span><span class="se">\n</span><span class="s">&quot;</span>
<a id="__codelineno-8-46" name="__codelineno-8-46"></a><span class="w">        </span><span class="s">&quot;    vec4 g = vec4(w0 + w1, w2 + w3);</span><span class="se">\n</span><span class="s">&quot;</span>
<a id="__codelineno-8-47" name="__codelineno-8-47"></a><span class="w">        </span><span class="s">&quot;    vec4 h = vec4(w1, w3) / g + inv.xyxy;</span><span class="se">\n</span><span class="s">&quot;</span>
<a id="__codelineno-8-48" name="__codelineno-8-48"></a><span class="w">        </span><span class="s">&quot;    h.xy -= vec2(2.0);</span><span class="se">\n</span><span class="s">&quot;</span>
<a id="__codelineno-8-49" name="__codelineno-8-49"></a><span class="w">        </span><span class="s">&quot;    /* sample four corners, then interpolate */</span><span class="se">\n</span><span class="s">&quot;</span>
<a id="__codelineno-8-50" name="__codelineno-8-50"></a><span class="w">        </span><span class="s">&quot;    vec4 p = pos.xyxy + /*pt*/_%hx.xyxy * h;</span><span class="se">\n</span><span class="s">&quot;</span>
<a id="__codelineno-8-51" name="__codelineno-8-51"></a><span class="w">        </span><span class="s">&quot;    vec4 c00 = textureLod(/*tex*/_%hx, p.xy, 0.0);</span><span class="se">\n</span><span class="s">&quot;</span>
<a id="__codelineno-8-52" name="__codelineno-8-52"></a><span class="w">        </span><span class="s">&quot;    vec4 c01 = textureLod(/*tex*/_%hx, p.xw, 0.0);</span><span class="se">\n</span><span class="s">&quot;</span>
<a id="__codelineno-8-53" name="__codelineno-8-53"></a><span class="w">        </span><span class="s">&quot;    vec4 c0 = mix(c01, c00, g.y);</span><span class="se">\n</span><span class="s">&quot;</span>
<a id="__codelineno-8-54" name="__codelineno-8-54"></a><span class="w">        </span><span class="s">&quot;    vec4 c10 = textureLod(/*tex*/_%hx, p.zy, 0.0);</span><span class="se">\n</span><span class="s">&quot;</span>
<a id="__codelineno-8-55" name="__codelineno-8-55"></a><span class="w">        </span><span class="s">&quot;    vec4 c11 = textureLod(/*tex*/_%hx, p.zw, 0.0);</span><span class="se">\n</span><span class="s">&quot;</span>
<a id="__codelineno-8-56" name="__codelineno-8-56"></a><span class="w">        </span><span class="s">&quot;    vec4 c1 = mix(c11, c10, g.y);</span><span class="se">\n</span><span class="s">&quot;</span>
<a id="__codelineno-8-57" name="__codelineno-8-57"></a><span class="w">        </span><span class="s">&quot;    color = /*scale*/_%hx * mix(c1, c0, g.x);</span><span class="se">\n</span><span class="s">&quot;</span>
<a id="__codelineno-8-58" name="__codelineno-8-58"></a><span class="w">        </span><span class="s">&quot;    }</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<a id="__codelineno-8-59" name="__codelineno-8-59"></a><span class="w">        </span><span class="n">vars</span><span class="p">.</span><span class="n">pos</span><span class="p">,</span>
<a id="__codelineno-8-60" name="__codelineno-8-60"></a><span class="w">        </span><span class="n">vars</span><span class="p">.</span><span class="n">tex</span><span class="p">,</span>
<a id="__codelineno-8-61" name="__codelineno-8-61"></a><span class="w">        </span><span class="n">vars</span><span class="p">.</span><span class="n">pt</span><span class="p">,</span>
<a id="__codelineno-8-62" name="__codelineno-8-62"></a><span class="w">        </span><span class="n">vars</span><span class="p">.</span><span class="n">tex</span><span class="p">,</span>
<a id="__codelineno-8-63" name="__codelineno-8-63"></a><span class="w">        </span><span class="n">vars</span><span class="p">.</span><span class="n">tex</span><span class="p">,</span>
<a id="__codelineno-8-64" name="__codelineno-8-64"></a><span class="w">        </span><span class="n">vars</span><span class="p">.</span><span class="n">tex</span><span class="p">,</span>
<a id="__codelineno-8-65" name="__codelineno-8-65"></a><span class="w">        </span><span class="n">vars</span><span class="p">.</span><span class="n">tex</span><span class="p">,</span>
<a id="__codelineno-8-66" name="__codelineno-8-66"></a><span class="w">        </span><span class="n">vars</span><span class="p">.</span><span class="n">scale</span>
<a id="__codelineno-8-67" name="__codelineno-8-67"></a><span class="w">    </span><span class="p">);</span>
<a id="__codelineno-8-68" name="__codelineno-8-68"></a>
<a id="__codelineno-8-69" name="__codelineno-8-69"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">vars</span><span class="p">);</span>
<a id="__codelineno-8-70" name="__codelineno-8-70"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>To support this style of shader programming, special syntax was invented:</p>
<h3 id="shader-variables">Shader variables</h3>
<p>Instead of being formatted with <code>"$"</code>, <code>%f</code> etc. and supplied in a big list,
printf style, GLSL macros may directly embed shader variables:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="n">ident_t</span><span class="w"> </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">tex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sh_bind</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span><span class="w"> </span><span class="n">texture</span><span class="p">,</span><span class="w"> </span><span class="p">...,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="p">...);</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="cp">#pragma GLSL vec4 color = texture($tex, $pos);</span>
</code></pre></div>
<p>The simplest possible shader variable is just <code>$name</code>, which corresponds to
any variable of type <code>ident_t</code>. More complicated expression are also possible:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="cp">#define RAND3 ${sh_prng(sh, false, NULL)}</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="n">color</span><span class="p">.</span><span class="n">rgb</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="err">$</span><span class="p">{</span><span class="kt">float</span><span class="o">:</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">noise</span><span class="p">}</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">RAND3</span><span class="p">;</span>
</code></pre></div>
<p>In the expression <code>${float:params-&gt;noise}</code>, the <code>float:</code> prefix here transforms
the shader variable into the equivalent of <code>SH_FLOAT()</code> in the legacy API,
that is, a generic float (specialization) constant. Other possible types are:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="n">TYPE</span><span class="w">  </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="p">{</span><span class="n">ident</span><span class="o">:</span><span class="w"> </span><span class="n">sh_desc</span><span class="p">(...)};</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="kt">float</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="p">{</span><span class="kt">float</span><span class="o">:</span><span class="w"> </span><span class="n">M_PI</span><span class="p">};</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="kt">int</span><span class="w">   </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="p">{</span><span class="kt">int</span><span class="o">:</span><span class="w">   </span><span class="n">params</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">};</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="kt">uint</span><span class="w">  </span><span class="n">u</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="p">{</span><span class="kt">uint</span><span class="o">:</span><span class="w">  </span><span class="kr">sizeof</span><span class="p">(</span><span class="n">ssbo</span><span class="p">)};</span>
</code></pre></div>
<p>In addition to a type specifier, the optional qualifiers <code>dynamic</code> and <code>const</code>
will modify the variable, turning it into (respectively) a dynamically loaded
uniform (<code>SH_FLOAT_DYN</code> etc.), or a hard-coded shader literal (<code>%d</code>, <code>%f</code>
etc.):</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="p">{</span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">:</span><span class="w"> </span><span class="n">M_LOG10E</span><span class="p">};</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="kt">int</span><span class="w"> </span><span class="n">seed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="p">{</span><span class="n">dynamic</span><span class="w"> </span><span class="kt">int</span><span class="o">:</span><span class="w"> </span><span class="n">rand</span><span class="p">()};</span>
</code></pre></div>
<p>For sampling from component masks, the special types <code>swizzle</code> and
<code>(b|u|i)vecType</code> can be used to generate the appropriate texture swizzle and
corresponding vector type:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="err">$</span><span class="p">{</span><span class="n">vecType</span><span class="o">:</span><span class="w"> </span><span class="n">comp_mask</span><span class="p">}</span><span class="w"> </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">color</span><span class="p">.</span><span class="err">$</span><span class="p">{</span><span class="n">swizzle</span><span class="o">:</span><span class="w"> </span><span class="n">comp_mask</span><span class="p">};</span>
</code></pre></div>
<h3 id="macro-directives">Macro directives</h3>
<p>Lines beginning with <code>@</code> are not included in the GLSL as-is, but instead parsed
as macro directives, to control the code flow inside the macro expansion:</p>
<h4 id="if-else">@if / @else</h4>
<p>Standard-purpose conditional. Example:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="kt">float</span><span class="w"> </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">...;</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="err">@</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">repr</span><span class="p">.</span><span class="n">alpha</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">PL_ALPHA_INDEPENDENT</span><span class="p">)</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="w">    </span><span class="n">color</span><span class="p">.</span><span class="n">a</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">alpha</span><span class="p">;</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="err">@</span><span class="k">else</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="w">    </span><span class="n">color</span><span class="p">.</span><span class="n">rgba</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">alpha</span><span class="p">;</span>
</code></pre></div>
<p>The condition is evaluated outside the macro (in the enclosing scope) and
the resulting boolean variable is directly passed to the template.</p>
<p>An <code>@if</code> block can also enclose multiple lines:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="err">@</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">threshold</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mo">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">thresh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="p">{</span><span class="kt">float</span><span class="o">:</span><span class="n">threshold</span><span class="p">};</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="w">    </span><span class="n">coeff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mix</span><span class="p">(</span><span class="n">coeff</span><span class="p">,</span><span class="w"> </span><span class="kt">vec2</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span><span class="w"> </span><span class="n">lessThan</span><span class="p">(</span><span class="n">coeff</span><span class="p">,</span><span class="w"> </span><span class="kt">vec2</span><span class="p">(</span><span class="n">thresh</span><span class="p">)));</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="w">    </span><span class="n">coeff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mix</span><span class="p">(</span><span class="n">coeff</span><span class="p">,</span><span class="w"> </span><span class="kt">vec2</span><span class="p">(</span><span class="mf">1.0</span><span class="p">),</span><span class="w"> </span><span class="n">greaterThan</span><span class="p">(</span><span class="n">coeff</span><span class="p">,</span><span class="w"> </span><span class="kt">vec2</span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">thresh</span><span class="p">)));</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="err">@</span><span class="p">}</span>
</code></pre></div>
<h4 id="for">@for</h4>
<p>This can be used to generate (unrolled) loops:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="kt">int</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="p">{</span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="o">:</span><span class="w"> </span><span class="n">params</span><span class="o">-&gt;</span><span class="n">kernel_width</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">};</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="kt">float</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="err">@</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">params</span><span class="o">-&gt;</span><span class="n">kernel_width</span><span class="p">)</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="w">    </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">textureLodOffset</span><span class="p">(</span><span class="err">$</span><span class="n">luma</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">(</span><span class="err">@</span><span class="n">sum</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">offset</span><span class="p">)).</span><span class="n">r</span><span class="p">;</span>
</code></pre></div>
<p>This introduces a local variable, <code>@x</code>, which expands to an integer containing
the current loop index. Loop indices always start at 0. Valid terminating
conditions include <code>&lt;</code> and <code>&lt;=</code>, and the loop stop condition is also evaluated
as an integer.</p>
<p>Alternatively, this can be used to iterate over a bitmask (as commonly used for
e.g. components in a color mask):</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="kt">float</span><span class="w"> </span><span class="n">weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="cm">/* ... */</span><span class="p">;</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="kt">vec4</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">textureLod</span><span class="p">(</span><span class="err">$</span><span class="n">tex</span><span class="p">,</span><span class="w"> </span><span class="err">$</span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">);</span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="err">@</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">params</span><span class="o">-&gt;</span><span class="n">component_mask</span><span class="p">)</span>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="w">    </span><span class="n">sum</span><span class="p">[</span><span class="err">@</span><span class="n">c</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">weight</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">color</span><span class="p">[</span><span class="err">@</span><span class="n">c</span><span class="p">];</span>
</code></pre></div>
<p>Finally, to combine loops with conditionals, the special syntax <code>@if @(cond)</code>
may be used to evaluate expressions inside the template loop:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="err">@</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="cm">/* ... */</span><span class="p">;</span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="w">    </span><span class="err">@</span><span class="k">if</span><span class="w"> </span><span class="err">@</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="w">        </span><span class="n">weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">weight</span><span class="p">;</span>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="w">    </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">weight</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">texture</span><span class="p">(...);</span>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="err">@</span><span class="p">}</span>
</code></pre></div>
<p>In this case, the <code>@if</code> conditional may only reference local (loop) variables.</p>
<h4 id="switch-case">@switch / @case</h4>
<p>This corresponds fairly straightforwardly to a normal switch/case from C:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="err">@</span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">color</span><span class="o">-&gt;</span><span class="n">transfer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="err">@</span><span class="k">case</span><span class="w"> </span><span class="n">PL_COLOR_TRC_SRGB</span><span class="o">:</span>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="w">    </span><span class="n">color</span><span class="p">.</span><span class="n">rgb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mix</span><span class="p">(</span><span class="n">color</span><span class="p">.</span><span class="n">rgb</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1.0</span><span class="o">/</span><span class="mf">12.92</span><span class="p">,</span>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="w">                    </span><span class="n">pow</span><span class="p">((</span><span class="n">color</span><span class="p">.</span><span class="n">rgb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="kt">vec3</span><span class="p">(</span><span class="mf">0.055</span><span class="p">))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1.055</span><span class="p">,</span><span class="w"> </span><span class="kt">vec3</span><span class="p">(</span><span class="mf">2.4</span><span class="p">)),</span>
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="w">                    </span><span class="n">lessThan</span><span class="p">(</span><span class="kt">vec3</span><span class="p">(</span><span class="mf">0.04045</span><span class="p">),</span><span class="w"> </span><span class="n">color</span><span class="p">.</span><span class="n">rgb</span><span class="p">));</span>
<a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a><span class="w">    </span><span class="err">@</span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="err">@</span><span class="k">case</span><span class="w"> </span><span class="n">PL_COLOR_TRC_GAMMA18</span><span class="o">:</span>
<a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a><span class="w">    </span><span class="n">color</span><span class="p">.</span><span class="n">rgb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pow</span><span class="p">(</span><span class="n">color</span><span class="p">.</span><span class="n">rgb</span><span class="p">,</span><span class="w"> </span><span class="kt">vec3</span><span class="p">(</span><span class="mf">1.8</span><span class="p">));</span>
<a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a><span class="w">    </span><span class="err">@</span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a><span class="err">@</span><span class="k">case</span><span class="w"> </span><span class="n">PL_COLOR_TRC_GAMMA20</span><span class="o">:</span>
<a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a><span class="w">    </span><span class="n">color</span><span class="p">.</span><span class="n">rgb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pow</span><span class="p">(</span><span class="n">color</span><span class="p">.</span><span class="n">rgb</span><span class="p">,</span><span class="w"> </span><span class="kt">vec3</span><span class="p">(</span><span class="mf">2.0</span><span class="p">));</span>
<a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a><span class="w">    </span><span class="err">@</span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a><span class="err">@</span><span class="k">case</span><span class="w"> </span><span class="n">PL_COLOR_TRC_GAMMA22</span><span class="o">:</span>
<a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a><span class="w">    </span><span class="n">color</span><span class="p">.</span><span class="n">rgb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pow</span><span class="p">(</span><span class="n">color</span><span class="p">.</span><span class="n">rgb</span><span class="p">,</span><span class="w"> </span><span class="kt">vec3</span><span class="p">(</span><span class="mf">2.2</span><span class="p">));</span>
<a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a><span class="w">    </span><span class="err">@</span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a><span class="cm">/* ... */</span>
<a id="__codelineno-19-17" name="__codelineno-19-17" href="#__codelineno-19-17"></a><span class="err">@</span><span class="p">}</span>
</code></pre></div>
<p>The switch body is always evaluated as an <code>unsigned int</code>.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2017-2022 Niklas Haas
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["content.code.annotate"], "search": "../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>